var J=(n,t,e)=>{if(!t.has(n))throw TypeError("Cannot "+e)};var r=(n,t,e)=>(J(n,t,"read from private field"),e?e.call(n):t.get(n)),h=(n,t,e)=>{if(t.has(n))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(n):t.set(n,e)},i=(n,t,e,s)=>(J(n,t,"write to private field"),s?s.call(n,e):t.set(n,e),e);var p=(n,t,e)=>(J(n,t,"access private method"),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const u of document.querySelectorAll('link[rel="modulepreload"]'))s(u);new MutationObserver(u=>{for(const c of u)if(c.type==="childList")for(const d of c.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&s(d)}).observe(document,{childList:!0,subtree:!0});function e(u){const c={};return u.integrity&&(c.integrity=u.integrity),u.referrerPolicy&&(c.referrerPolicy=u.referrerPolicy),u.crossOrigin==="use-credentials"?c.credentials="include":u.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function s(u){if(u.ep)return;u.ep=!0;const c=e(u);fetch(u.href,c)}})();class K{constructor(t){this.value=t}get ok(){return!0}get err(){return!1}expect(){return this.value}expectErr(t){throw new Error(t)}get unwrap(){return this.value}unwrapOr(){return this.value}andThen(t){return t(this.value)}orElse(){return this}map(t){return new K(t(this.value))}mapErr(){return this}get toOptional(){return new Q(this.value)}safeUnwrap(){return this.value}}var E;const re=class re{constructor(t){h(this,E,void 0);i(this,E,new Error().stack),this.error=t}get valid(){return!1}get ok(){return!1}get err(){return!0}expect(t){throw new Error(t+`
Original `+r(this,E)+`
Expect Error`)}expectErr(){return this.error}get unwrap(){throw new Error(`Tried to unwrap Error
Original `+r(this,E)+`
Unwrap Error`)}unwrapOr(t){return t}andThen(){return this}orElse(t){return t(this.error)}map(){return this}mapErr(t){return new re(t(this.error))}get toOptional(){return new se}get stack(){return r(this,E)}};E=new WeakMap;let V=re;class Q{constructor(t){this.value=t}get valid(){return!0}get some(){return!0}get none(){return!1}expect(){return this.value}get unwrap(){return this.value}unwrapOr(){return this.value}andThen(t){return t(this.value)}orElse(){return this}map(t){return new Q(t(this.value))}toResult(){return new K(this.value)}}class se{get valid(){return!1}get some(){return!1}get none(){return!0}expect(t){throw new Error(t)}get unwrap(){throw new Error("Tried to unwrap None")}unwrapOr(t){return t}andThen(){return this}orElse(t){return t()}map(){return this}toResult(t){return new V(t)}}function l(n){return new K(n)}function W(n){return new V(n)}function X(n){return new Q(n)}function ie(){return new se}class Z{constructor(){this.subscribers=[]}subscribe(t,e){return this.subscribers.includes(t)?(console.warn("Function already registered as subscriber"),t):(this.subscribers.push(t),e&&this.then(s=>{t(s)}),t)}unsubscribe(t){const e=this.subscribers.indexOf(t);return e!=-1?this.subscribers.splice(e,1):console.warn("Subscriber not found with state",this,t),t}related(){return ie()}inUse(){return!!this.subscribers.length}hasSubscriber(t){return this.subscribers.includes(t)}updateSubscribers(t){for(let e=0,s=this.subscribers.length;e<s;e++)try{this.subscribers[e](t)}catch(u){console.warn("Failed while calling subscribers ",u,this,this.subscribers[e])}}}var f,O,b,M;class j extends Z{constructor(e,s,u,c){super();h(this,f,void 0);h(this,O,void 0);h(this,b,void 0);h(this,M,void 0);s&&i(this,O,s===!0?d=>r(this,b)?r(this,b).limit(d).map(k=>l(k)):X(l(d)):s),u&&i(this,b,u),c&&i(this,M,c),e instanceof Promise?(this.then=e.then.bind(e),e.then(d=>{i(this,f,d),delete this.then})):typeof e=="function"?this.then=async d=>{let k=e();return this.then=k.then,k.then(oe=>{i(this,f,oe),delete this.then}),k.then(d)}:i(this,f,e)}async then(e){return e(r(this,f))}related(){return r(this,M)?r(this,M).call(this):ie()}write(e){r(this,O)&&r(this,f).value!==e&&r(this,O).call(this,e).map(this.set.bind(this))}check(e){return r(this,b)?r(this,b).check(e):void 0}limit(e){return r(this,b)?r(this,b).limit(e):X(e)}set(e){i(this,f,e),this.updateSubscribers(e)}}f=new WeakMap,O=new WeakMap,b=new WeakMap,M=new WeakMap;var D,v,m,a,y,S;class ce extends Z{constructor(){super(...arguments);h(this,D,0);h(this,v,!1);h(this,m,void 0);h(this,a,[]);h(this,y,0);h(this,S,0)}async then(e){if(r(this,D)>=Date.now())return e(r(this,m));if(r(this,v))return e(await new Promise(s=>{r(this,a).push(s),console.log(r(this,a))}));i(this,v,!0),this.debounce>0&&await new Promise(s=>{setTimeout(s,this.debounce)}),i(this,m,await this.singleGet()),i(this,D,Date.now()+this.timeout);for(let s=0;s<r(this,a).length;s++)r(this,a)[s](r(this,m));return i(this,a,[]),i(this,v,!1),e(r(this,m))}updateResource(e){i(this,m,e),i(this,D,Date.now()+this.timeout);for(let s=0;s<r(this,a).length;s++)r(this,a)[s](r(this,m));i(this,a,[]),i(this,v,!1),this.updateSubscribers(e)}subscribe(e,s){return this.subscribers.length===0?(this.subscribers.push(e),r(this,y)?(clearTimeout(r(this,y)),i(this,y,0)):(i(this,v,!0),this.debounce>0?i(this,S,setTimeout(()=>{this.setupConnection(this.updateResource.bind(this)),i(this,S,0)},this.debounce)):this.setupConnection(this.updateResource.bind(this))),e):super.subscribe(e,s)}unsubscribe(e){return this.subscribers.length===1&&(r(this,S)?(clearTimeout(r(this,S)),i(this,S,0)):this.retention>0?i(this,y,setTimeout(()=>{this.teardownConnection(),i(this,y,0)},this.retention)):this.teardownConnection()),super.unsubscribe(e)}check(e){}limit(e){return X(e)}}D=new WeakMap,v=new WeakMap,m=new WeakMap,a=new WeakMap,y=new WeakMap,S=new WeakMap;var C,T,o,g,L,w,A,Y,H,F,N,U;class le extends Z{constructor(e,...s){super();h(this,A);h(this,H);h(this,N);h(this,C,!1);h(this,T,void 0);h(this,o,void 0);h(this,g,[]);h(this,L,[]);h(this,w,0);typeof e=="function"?(this.getter=e,i(this,o,s)):i(this,o,arguments)}getter(e){return e[0]}subscribe(e,s){return this.subscribers.length===0?(this.subscribers.push(e),p(this,H,F).call(this),e):super.subscribe(e,s)}unsubscribe(e){return this.subscribers.length===1&&p(this,N,U).call(this),super.unsubscribe(e)}async then(e){return r(this,C)?e(r(this,T)):r(this,o).length?e(this.getter(await Promise.all(r(this,o)))):e(W({reason:"No states registered",code:"INV"}))}setStates(...e){this.subscribers.length?(p(this,N,U).call(this),i(this,o,[...e]),p(this,H,F).call(this)):i(this,o,[...e])}setGetter(e){this.subscribers.length?(p(this,N,U).call(this),this.getter=e,p(this,H,F).call(this)):this.getter=e}}C=new WeakMap,T=new WeakMap,o=new WeakMap,g=new WeakMap,L=new WeakMap,w=new WeakMap,A=new WeakSet,Y=async function(){await void 0,i(this,C,!0),i(this,T,this.getter(r(this,g))),this.updateSubscribers(r(this,T)),i(this,w,1)},H=new WeakSet,F=function(){if(i(this,w,0),r(this,o).length>1){let e=r(this,o).length;for(let s=0;s<r(this,o).length;s++)r(this,L)[s]=r(this,o)[s].subscribe(u=>{r(this,w)===1?(r(this,g)[s]=u,i(this,w,2),p(this,A,Y).call(this)):r(this,w)===0&&!r(this,g)[s]?(r(this,g)[s]=u,e--,e===0&&(i(this,w,2),p(this,A,Y).call(this))):r(this,g)[s]=u},!0)}else r(this,L)[0]=r(this,o)[0].subscribe(e=>{i(this,C,!0),i(this,T,this.getter([e])),this.updateSubscribers(r(this,T))})},N=new WeakSet,U=function(){i(this,C,!1);for(let e=0;e<r(this,o).length;e++)r(this,o)[e].unsubscribe(r(this,L)[e]);i(this,L,[]),i(this,g,[])};class ae extends le{getter(t){let e=0;for(let s=0;s<t.length;s++){let u=t[s];if(u.ok)e+=u.value;else return u}return l(e)}}let de=new j(l(1));de.write(5);class be{constructor(){this.value=0,this.quality=1,setInterval(()=>{this.value++},100)}async fetch(){if(await new Promise(t=>{setTimeout(t,90+Math.random()*20)}),Math.random()+this.quality>1)return this.value;throw"Connection lost"}set connectionQuality(t){this.quality=t}}var P,B;class pe extends ce{constructor(e){super();h(this,P,void 0);h(this,B,void 0);i(this,P,e)}get debounce(){return 10}get timeout(){return 2e3}get retention(){return 250}async singleGet(){try{return l(await r(this,P).fetch())}catch(e){return W({code:"CL",reason:e})}}setupConnection(e){i(this,B,setInterval(async()=>{try{e(l(await r(this,P).fetch()))}catch(s){e(W({code:"CL",reason:s}))}},500))}teardownConnection(){clearInterval(r(this,B))}write(e){}}P=new WeakMap,B=new WeakMap;let $=new be;window.server=$;let z=new pe($);window.client=z;let x=document.createElement("input");x.type="range";x.min="0";x.max="1";x.step="0.05";x.oninput=()=>{$.quality=Number(x.value)};document.body.appendChild(x);let R=document.createElement("button");R.innerHTML="Single Get";R.onclick=async()=>{(await z).andThen(t=>(R.innerHTML="Single Get "+String(t),l(!1))).orElse(t=>(R.innerHTML="Single Get "+String(t.reason),l(!1)))};document.body.appendChild(R);let G=document.createElement("button");G.innerHTML="Connect";let ne;G.onclick=()=>{ne=z.subscribe(n=>{n.err?G.innerHTML="Connect "+String(n.error.reason):G.innerHTML="Connect "+String(n.value)})};document.body.appendChild(G);let _=document.createElement("button");_.innerHTML="Disconnect";_.onclick=()=>{z.unsubscribe(ne)};document.body.appendChild(_);let ee=new j(l(1)),fe=new j(l(2)),me=new j(l(3)),ue=new ae(ee,fe,me),q=document.createElement("input");q.type="number";ee.subscribe(n=>{q.valueAsNumber=n.unwrap},!0);q.onchange=()=>{ee.set(l(q.valueAsNumber))};document.body.appendChild(q);let I=document.createElement("button");I.innerHTML="Derived Connect";let he;I.onclick=()=>{he=ue.subscribe(n=>{n.err?I.innerHTML="Derived Connect "+String(n.error.reason):I.innerHTML="Derived Connect "+String(n.value)})};document.body.appendChild(I);let te=document.createElement("button");te.innerHTML="Derived Disconnect";te.onclick=()=>{ue.unsubscribe(he)};document.body.appendChild(te);
